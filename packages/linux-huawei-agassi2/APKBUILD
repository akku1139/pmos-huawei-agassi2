# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/(CHANGEME!)

pkgname=linux-huawei-agassi2
pkgver=4.4.23
pkgrel=0
pkgdesc="Huawei Mediapad T5 kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="huawei-agassi2"
url="https://github.com/akku1139/android_kernel_huawei_agassi2"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	findutils
	flex
	openssl-dev
	perl
	grep
"

# Source
_repository="android_kernel_huawei_agassi2"
_commit="acb06e8cf69d9ec3feedb23fc28a0d1437b1131d"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/akku1139/$_repository/archive/$_commit.tar.gz
	$_config
	linux4.2-gcc10-extern_YYLOC_global_declaration.patch
	fix-check-lxdialog.patch
	01_use_linux_alpine_crosscompile.patch
	02_fix_undeclared_AID_INET.patch
	03_add_compression_methods_to_Kconfig.patch
	04_make_rdr_hisi_adapter_compileable.patch
	05-disable-huawei-bfmr.patch
	dtc-tool::https://github.com/JohnBergago/android_kernel_huawei_hi3660/raw/pmbootstrap_ready/tools/dtc
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	mkdir -p "$builddir/tools"
	cp "$srcdir/dtc-tool" "$builddir/tools/dtc"
	chmod +x "$builddir/tools/dtc"
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" \
		"$_flavor" "$_outdir"
}

sha512sums="
77e7100e512e1b6de22768738ede49e43340540edf5a5d885566c81470ef300483ce67e31cdc5533deb7e2c4be165a17a6a38cae4dc8da0f8658218029b18aa5  linux-huawei-agassi2-acb06e8cf69d9ec3feedb23fc28a0d1437b1131d.tar.gz
d6feca144469ab8e8a9377f390b7858c2d6bf6a4e298765f7567df1a614e020d73f3bdf974a9517ad79385862688816da44b8be22f4d5a7649aa05b2ab9d6e0c  config-huawei-agassi2.aarch64
eaf2e61fcb508cdd239b8fed209d2a09ecac77287f6b46d003918fdf1c6fa2ee63f7390f3ff7c49029b8ed6cbcdd81c7e9a4b1ece9f5060b6fc84e322bd47f41  linux4.2-gcc10-extern_YYLOC_global_declaration.patch
182be3c596b9cc267ac108d7cf03fc8c328ccc6b36770800e4dcedea8d1bb65e3f5eacf590c2948f58b1418cc60a1670ba77dde8c259e428d158c31b6e1dbaf5  fix-check-lxdialog.patch
5473a038ca5703cf4119957ca3af66972c121aa66fe262a3165e5a0e5714037670a96600eedd0488150ff754ead93f43299587554ca6c05022bb55f780d1cd7a  01_use_linux_alpine_crosscompile.patch
03df93e697a1a63bb6003af569850f7bb54749127b8cef8d9c0aa9be1487b9e33e5454d258454d01d8e70ad776e8b4730569549390d327f0cf0d50a5334b8f7e  02_fix_undeclared_AID_INET.patch
86afc1337a34524c49e9beaad6506f7038a7413340abc473f8d209a4d3cd6ebbcf8315ae41902427edf97064742c02e2e5bb705a8bcd36d1cae19f76a509e235  03_add_compression_methods_to_Kconfig.patch
cdc60b6c829df3b014226b9cb506ed71cf005cf5fec8d4339b54a23f052465501aaa4983ec00f33ef301db2e6a70b24a30439b3f6ce8f7c00348c05d3132ec3f  04_make_rdr_hisi_adapter_compileable.patch
6e420722576111a7ba49f265a66de632631c13d1bdb67553916d2156149226526daedc8298d83a38115c0a7189497cdb92b0daa0a263a92e6093f575e855a6e5  05-disable-huawei-bfmr.patch
e099439ce46ce186ac452c2d0696f32eefe7a398797f726bbfdbfd0b4a99e6f74405b6a53bbaf43b7a9982709fcb90566d1ee2bcb1ba7c2d896972771e979640  dtc-tool
"
